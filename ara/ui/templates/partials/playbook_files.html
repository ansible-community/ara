{% load truncatepath %}
{% load static_url %}
{% load filetree %}

<div class="accordion" id="files">
  <div class="card">
    <div class="card-header bg-body-tertiary" id="files_card">
      <button class="btn ara-card-collapse" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_files" aria-expanded="false" aria-controls="collapse_files">
        <h4>
          <i class="bi bi-files"></i>
          Files
        </h4>
      </button>
    </div>
    <div id="collapse_files" class="collapse show" aria-labelledby="files_card" data-bs-parent="#files" style="max-height: 275px; overflow-y: auto;">
      <div class="card-body">
        {% if playbook.items.files %}
          <div class="filetree" id="filetree-{{ playbook.id }}">
            <ul>
              {% with tree=files|as_filetree %}
                {% include "partials/filetree_node.html" with nodes=tree %}
              {% endwith %}
            </ul>
          </div>
        {% else %}
          <p>No recorded files found.</p>
          <p>The playbook might have been interrupted or is in progress.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  {% if playbook.items.files %}
  const treeContainer = document.getElementById('filetree-{{ playbook.id }}');

  // Keep toggle button state in sync with collapse state
  treeContainer.querySelectorAll('.filetree-children.collapse').forEach(function(collapseEl) {
    collapseEl.addEventListener('show.bs.collapse', function() {
      const toggle = this.previousElementSibling;
      if (toggle && toggle.classList.contains('filetree-toggle')) {
        toggle.classList.remove('collapsed');
      }
    });
    collapseEl.addEventListener('hide.bs.collapse', function() {
      const toggle = this.previousElementSibling;
      if (toggle && toggle.classList.contains('filetree-toggle')) {
        toggle.classList.add('collapsed');
      }
    });
  });
  {% endif %}
});
</script>
